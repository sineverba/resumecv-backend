version: v1.0
name: Test
agent:
  machine:
    type: e1-standard-2

  #containers:
  #  - name: main
  #    image: sineverba/php8xc:1.12.0

global_job_config:
  secrets:
    - name: ACCESS_TOKENS
    - name: VPS
  env_vars:
    - name: SONARSCANNER_VERSION
      value: 4.8.0.2856
    - name: FOLDER_APP
      value: resumecv-backend

blocks:
  - name: "Unit tests"
    skip:
      when: "tag =~ '.*'"
    task:
      jobs:
        - name: Test VPS
          commands:
            - ssh-keyscan -p $VPS01_OCI_PORT -H $VPS01_OCI_URL >> ~/.ssh/known_hosts
            - chmod 0600 ~/.ssh/id_semaphore
            - ssh-add ~/.ssh/id_semaphore
            - >-
              ssh -t $VPS01_OCI_USERNAME@$VPS01_OCI_URL -p $VPS01_OCI_PORT
              "sed -i \"/image\: registry.gitlab.com\/cicdprojects\/resumecv-backend:/c\    image\: registry.gitlab.com\/cicdprojects\/resumecv-backend\:9.8.7\" $FOLDER_APP/backup && exit"

promotions:
  - name: Deploy
    pipeline_file: build-deploy.yml
    auto_promote:
      when: "result = 'passed' and tag =~ '.*'"
