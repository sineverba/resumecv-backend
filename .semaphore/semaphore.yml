version: v1.0
name: Test
agent:
  machine:
    type: e1-standard-2

  containers:
    - name: main
      image: sineverba/php8xc:1.14.0

global_job_config:
  secrets:
    - name: ACCESS_TOKENS
  env_vars:
    - name: SONARSCANNER_VERSION
      value: 4.8.0
    - name: PHP8XC_VERSION
      value: 1.14.0

blocks:
  - name: "Unit tests"
    skip:
      when: "tag =~ '.*'"
    task:
      jobs:
        - name: "Run PHPUnit"
          commands:
            - checkout
            - sed -i -e 's,/data,/root/resumecv-backend,g' sonar-project.properties
            - composer install
            - cp .env.example .env
            - php artisan key:generate
            - ./vendor/bin/phpunit
            #- PHP_CS_FIXER_IGNORE_ENV=1 vendor/bin/php-cs-fixer fix docker --dry-run --rules=@PSR2
            - echo $SEMAPHORE_GIT_DIR
            - echo $PWD
            - echo $(PWD)
            - >-
              docker run
              --rm
              -e SONAR_HOST_URL="https://sonarcloud.io"
              -e SONAR_LOGIN=$SONAR_TOKEN
              -v "/home/semaphore/resumecv-backend:/usr/src"
              sonarsource/sonar-scanner-cli:$SONARSCANNER_VERSION

promotions:
  - name: Build
    pipeline_file: build.yml
    auto_promote:
      when: "result = 'passed' and tag =~ '.*'"
