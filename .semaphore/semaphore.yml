version: v1.0

name: Build and deploy
agent:
  machine:
    type: e1-standard-2
    os_image: ubuntu2004

global_job_config:
  secrets:
    - name: ACCESS_TOKENS
    - name: VPS

  env_vars:
    - name: DOCKER_IMAGE
      value: registry.gitlab.com/cicdprojects/resumecv-backend
    - name: GITLAB_REGISTRY
      value: registry.gitlab.com
    - name: BUILDX_VERSION
      value: 0.10.0
    - name: BINFMT_VERSION
      value: qemu-v7.0.0-28
    - name: FOLDER_APP
      value: resumecv-backend

blocks:
  - name: "Deploy APP"
    task:
      jobs:
        - name: Deploy to VPS
          commands:
            - ssh-keyscan -p $VPS01_OCI_PORT -H $VPS01_OCI_URL >> ~/.ssh/known_hosts
            - chmod 0600 ~/.ssh/id_semaphore
            - ssh-add ~/.ssh/id_semaphore
            # 3 - Remove the container and the image
            - >-
              ssh -t $VPS01_OCI_USERNAME@$VPS01_OCI_URL -p $VPS01_OCI_PORT
              "cd $FOLDER_APP && current_tag=$(sed -n 4p docker-compose.yml | tail -c 6) && docker-compose stop && docker container rm $FOLDER_APP && docker image rm $DOCKER_IMAGE:$current_tag && exit"
